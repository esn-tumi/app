<mat-progress-bar
  mode="indeterminate"
  *ngIf="(profile$ | async) === null"
></mat-progress-bar>
<main *ngIf="profile$ | async as profile">
  <div
    class="bg-slate-200 p-8 lg:py-14"
    fxLayout="column"
    fxLayoutAlign="space-evenly center"
    fxLayoutGap="2rem"
  >
    <div class="bg-white shadow-lg rounded-lg p-4 flex flex-col items-center relative overflow-hidden max-w-[90vw] w-[90vw] sm:w-[400px] text-center">
      <div class="absolute top-0 left-0 w-full h-[80px] bg-blue-500 flex items-center p-4 justify-between">
        <img
          src="/assets/logos/full_white.svg"
          alt="ESN TUMi Logo"
          class="w-24 object-contain"
        />
        <h1 *ngIf="profile.hasESNCard" class="text-white text-xl font-bold">ESNcard</h1>
      </div>
      <img
      [src]="profile.picture"
      class="rounded-full h-[128px] w-[128px] border-white border-[3px] z-10"
      referrerpolicy="no-referrer"
      />
      <div class="text-3xl font-bold mt-4 mb-1">{{ profile.fullName }}</div>
      <div *ngIf="profile.country" class="italic mb-1">{{ profile.country }}</div>
      <div *ngIf="profile.position" class="mb-3">
        <span class="bg-blue-500 px-2 py-1 text-sm text-white rounded-lg">{{ profile.position }}</span>
      </div>
      <div class="mt-1">
        <span *ngIf="profile.bio">{{ profile.bio }}</span>
        <span *ngIf="!profile.bio" class="text-gray-400 italic">no bio</span>
      </div>
      <mat-divider class="w-full !my-4"></mat-divider>
      <div class="flex flex-col items-center gap-1 text-sm">        
        <div class="">
          <span *ngIf="profile.university && profile.university.length <= 3" class="font-semibold">{{ profile.university | uppercase }}</span>
          <span *ngIf="profile.studyProgram" class="font-light"> {{ profile.studyProgram }}</span>
        </div>
        
        <div *ngIf="profile.homeUniversity" class="flex items-center gap-1">
          <mat-icon svgIcon="icon-home" style="min-width: 18px; max-width: 18px"></mat-icon>
          <div>{{ profile.homeUniversity }}</div>
        </div>
        <div *ngIf="profile.instagram" class="flex items-center gap-1 text-pink-600">
          <mat-icon svgIcon="icon-instagram-new" style="min-width: 18px; max-width: 18px"></mat-icon>
          <a href="https://www.instagram.com/{{ profile.instagram }}" target="blank">{{ profile.instagram }}</a>
        </div>
      </div>
      <div class="absolute right-2 bottom-2">
        <button mat-mini-fab class="modern" color="accent" (click)="updateProfile()">
          <mat-icon svgIcon="icon-edit"></mat-icon>
        </button>

      </div>
    </div>
  </div>
  <div
    class="m-4 overflow-hidden"
    gdAuto
    gdColumns="100%"
    gdColumns.gt-sm="calc(50% - 0.5rem) calc(50% - 0.5rem)"
    gdGap="1rem"
  >
    <div
      class="bg-secondary-container text-secondary-onContainer rounded-2xl p-4"
    >
      <div
        fxLayout="row"
        fxLayoutAlign="start center"
        fxLayoutGap="1rem"
        class="mb-6"
      >
        <mat-icon
          svgIcon="icon-contact-card"
          class="text-secondary-default bg-secondary-on card-icon"
        >
        </mat-icon>
        <h2 class="font-bold">Private Information</h2>
      </div>
      <div gdAuto gdColumns="1fr 2fr" gdGap="0 1rem" class="mb-2">
        <p>Mail:</p>
        <p>{{ profile.email }}</p>
        <p>Phone:</p>
        <p>{{ profile.phone ?? 'not saved' }}</p>
        <p>Birthday:</p>
        <p>{{ profile.birthdate | date: 'mediumDate' }}</p>
        <p>ESNcard:</p>
        <p>{{ profile.hasESNCard ? 'Yes' : 'No' }}</p>
      </div>
      <div class="mt-2 flex w-full flex-col gap-2">
        <button mat-raised-button class="modern" (click)="updateUserInformation()">
          <mat-icon svgIcon="icon-change-user-female"></mat-icon>
          Update data
        </button>
      </div>
      <h3 class="mt-6 font-bold">Calendar integration</h3>

      <p class="select-all break-words font-mono" style="max-width: 80vw">
        https://tumi.esn.world/cal/private/{{ profile.calendarToken }}
      </p>

      <p class="text-sm">
        You can use this url to subscribe to a calendar feed of the events you
        are registered for.
      </p>
    </div>
    <!--<div
      class="bg-secondary-container text-secondary-onContainer rounded-2xl p-4"
    >
      <div
        fxLayout="row"
        fxLayoutAlign="start center"
        fxLayoutGap="1rem"
        class="mb-6"
      >
        <mat-icon
          svgIcon="icon-card-in-use"
          class="text-secondary-default bg-secondary-on card-icon"
        ></mat-icon>
        <h2 class="font-bold">Payment Information</h2>
      </div>
      <p class="mb-4">
        To register for paid events, you can add a payment method here. It will
        show up when registering.
      </p>
      <ng-container *ngIf="profile.currentTenant?.stripeData?.paymentMethodId">
        <p>✔️ All good, we have a payment method saved for you</p>
        <p class="mb-4">
          If you wish, you can go through the process again to change your
          payment method
        </p>
      </ng-container>

      <button mat-flat-button color="accent" (click)="setupStripePayment()">
        Set payment method
      </button>
    </div>-->
    <div
      *ngIf="(eventsToRate$ | async)?.length"
      class="bg-secondary-container text-secondary-onContainer rounded-2xl p-4"
    >
      <div
        fxLayout="row"
        fxLayoutAlign="start center"
        fxLayoutGap="1rem"
        class="mb-6"
      >
        <mat-icon
          svgIcon="icon-star"
          class="text-secondary-default bg-secondary-on card-icon"
        ></mat-icon>
        <h2 class="font-bold">Rate Events</h2>
      </div>
      <p class="mb-4">
        Please take a little time to rate these events you took part in so we
        can improve.
      </p>
      <div
        fxLayout="column"
        fxLayoutGap="1rem"
        *ngIf="eventsToRate$ | async as events"
      >
        <app-rate-event
          *ngFor="let event of events"
          [event]="event"
          (ratingSubmitted)="saveRating($event, event.id)"
        >
        </app-rate-event>
      </div>
    </div>
    <app-event-list
      [events]="profile.organizedEvents"
      [isOrganized]="true"
      *ngIf="profile.organizedEvents.length"
    ></app-event-list>
    <app-event-list
      [events]="profile.participatedEvents"
      [isOrganized]="false"
      (claimRequest)="claimEvent()"
    ></app-event-list>
    <div
      class="bg-primary-container text-primary-onContainer rounded-2xl p-4"
      *ngIf="profile.currentTenant?.status !== MembershipStatus.None"
    >
      <div
        fxLayout="row"
        fxLayoutAlign="start center"
        fxLayoutGap="1rem"
        class="mb-6"
      >
        <mat-icon
          svgIcon="icon-conference"
          class="text-primary-default card-icon bg-white"
        ></mat-icon>
        <h2 class="font-bold">Section membership</h2>
      </div>
      <div>
        Current status:
        <div class="black text-8xl text-center">
          {{ profile.currentTenant?.status | uppercase }}
        </div>
      </div>
    </div>
  </div>
</main>
